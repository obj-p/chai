default_platform(:ios)

platform :ios do
  desc "Sync certificates and profiles using match"
  lane :sync_certs do
    match(type: "adhoc", readonly: is_ci)
  end

  desc "Build ad-hoc IPA"
  lane :build do
    sync_certs

    Dir.chdir("..") { sh("xcodegen") }

    gym(
      scheme: "Chai",
      project: "Chai.xcodeproj",
      export_method: "ad-hoc",
      output_directory: "dist",
      output_name: "Chai",
      clean: true,
      configuration: "Release"
    )
  end

  desc "Build and publish to appserve"
  lane :distribute do
    build
    publish_to_appserve
  end

  private_lane :publish_to_appserve do
    require 'fileutils'

    appserve_dir = ENV['APPSERVE_DIR'] || File.expand_path("~/Projects/appserve")
    version = get_version_number(xcodeproj: "Chai.xcodeproj", target: "Chai")
    commit = `git rev-parse --short HEAD`.strip
    dist = File.expand_path("../dist", Dir.pwd)

    icon = File.expand_path("../Chai/Assets.xcassets/AppIcon.appiconset/AppIcon.png", Dir.pwd)
    FileUtils.cp(icon, "#{dist}/icon.png") if File.exist?(icon)

    touch_icon = File.expand_path("../static/apple-touch-icon.png", Dir.pwd)
    FileUtils.cp(touch_icon, "#{dist}/apple-touch-icon.png") if File.exist?(touch_icon)

    sh("#{appserve_dir}/publish.sh",
      "--app", "chai", "--version", version, "--ipa", "#{dist}/Chai.ipa",
      "--bundle-id", "com.objp.chai.Chai", "--title", "Chai",
      "--icon", "#{dist}/icon.png", "--touch-icon", "#{dist}/apple-touch-icon.png",
      "--commit", commit,
      "--note", "After installing, go to Settings → General → VPN & Device Management to trust the certificate.")
  end
end
